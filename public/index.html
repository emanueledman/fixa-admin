<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FixABairro - Painel Administrativo">
  <meta name="keywords" content="fixabairro, angola, serviços públicos, administração">
  <meta name="author" content="FixABairro Team">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <title>FixABairro | Painel Administrativo</title>
  <style>
    :root {
      --primary-color: #22c55e;
      --primary-dark: #16a34a;
      --secondary-color: #f59e0b;
      --dark-bg: #1f2937;
      --dark-card: #2d3748;
      --light-text: #f3f4f6;
      --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      --accent-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #0ea5e9;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--dark-bg);
      color: var(--light-text);
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }
    
    .navbar {
      background: rgba(31, 41, 55, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 2rem;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .navbar.scrolled {
      padding: 0.5rem 2rem;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      font-weight: 700;
      font-size: 1.75rem;
      color: white;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      margin-right: 12px;
      filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5));
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover .logo {
      transform: scale(1.1);
    }
    
    .nav-link {
      font-weight: 500;
      position: relative;
      margin: 0 0.5rem;
      padding: 0.5rem 1rem !important;
      transition: all 0.3s ease;
      color: var(--light-text) !important;
    }
    
    .nav-link:not(.btn)::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: 0;
      left: 50%;
      background-color: var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .nav-link:not(.btn):hover::after {
      width: 80%;
      left: 10%;
    }
    
    .nav-link.btn {
      background-color: var(--primary-color);
      border: none;
      border-radius: 50px;
      padding: 0.6rem 1.75rem !important;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(34, 197, 94, 0.5);
      color: white !important;
    }
    
    .nav-link.btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(34, 197, 94, 0.5);
    }
    
    .dropdown-menu {
      background: var(--dark-card);
      border: 1px solid rgba(34, 197, 94, 0.2);
      box-shadow: var(--card-shadow);
      border-radius: 8px;
    }
    
    .dropdown-item {
      color: var(--light-text);
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    .dropdown-item:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .container-fluid {
      max-width: 1400px;
      padding: 2rem;
    }
    
    .card {
      background: var(--dark-card);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    .form-control, .form-select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--light-text);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(34, 197, 94, 0.25);
      color: var(--light-text);
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(34, 197, 94, 0.5);
    }
    
    .btn-outline-secondary {
      border-radius: 50px;
      padding: 0.75rem 2rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--light-text);
      transition: all 0.3s ease;
    }
    
    .btn-outline-secondary:hover {
      background-color: rgba(34, 197, 94, 0.2);
      border-color: var(--primary-color);
      transform: translateY(-2px);
      color: white;
    }
    
    .map-container {
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(34, 197, 94, 0.2);
      box-shadow: var(--card-shadow);
    }
    
    .pagination .page-link {
      background: var(--dark-card);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: var(--light-text);
      transition: all 0.3s ease;
    }
    
    .pagination .page-link:hover {
      background: var(--primary-color);
      border-color: var(--primary-dark);
      color: white;
    }
    
    .pagination .page-item.active .page-link {
      background: var(--primary-color);
      border-color: var(--primary-dark);
    }
    
    .badge {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border-radius: 50px;
    }
    
    .modal-content {
      background: var(--dark-card);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 12px;
    }
    
    .modal-header, .modal-footer {
      border-color: rgba(34, 197, 94, 0.2);
    }
    
    .toast {
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }
    
    .select-container {
      position: relative;
    }
    
    select.form-control, select.form-select {
      appearance: none;
      padding-right: 2.5rem;
    }
    
    .select-container::after {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.5);
      pointer-events: none;
    }
    
    @media (max-width: 768px) {
      .container-fluid {
        padding: 1rem;
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .map-container {
        height: 300px;
      }
      
      .nav-link {
        padding: 0.5rem !important;
      }
    }
    
    @media (max-width: 576px) {
      .navbar-brand {
        font-size: 1.5rem;
      }
      
      .logo {
        width: 30px;
        height: 30px;
      }
      
      .row-cols-md-2 > * {
        flex: 0 0 100%;
        max-width: 100%;
      }
      
      .btn, .form-control, .form-select {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="icons/Icon-192.png" alt="Logo FixABairro" class="logo">
        FixABairro
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-section="problems">Problemas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-section="map">Mapa</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-section="reports">Relatórios</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-globe"></i> Idioma
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
              <li><a class="dropdown-item" href="#" data-lang="pt-BR">Português</a></li>
              <li><a class="dropdown-item" href="#" data-lang="en-US">English</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <button id="logoutButton" class="nav-link btn btn-link text-white"><i class="bi bi-box-arrow-right"></i> Sair</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid mt-4">
    <!-- Problems Section -->
    <div id="problemsSection" class="section">
      <div class="row mb-4" data-aos="fade-down">
        <div class="col-md-6">
          <h1 class="display-6">Problemas Reportados</h1>
        </div>
        <div class="col-md-6 text-end">
          <span id="notificationStatus" class="badge bg-success"></span>
        </div>
      </div>
      <div class="card mb-4" data-aos="fade-up">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <input id="searchInput" type="text" class="form-control" placeholder="Buscar por título...">
            </div>
            <div class="col-md-3">
              <div class="select-container">
                <select id="statusFilter" class="form-select">
                  <option value="">Todos os Status</option>
                  <option value="Aguardando">Aguardando</option>
                  <option value="Em Andamento">Em Andamento</option>
                  <option value="Resolvido">Resolvido</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="select-container">
                <select id="urgencyFilter" class="form-select">
                  <option value="">Todas as Urgências</option>
                  <option value="Baixa">Baixa</option>
                  <option value="Média">Média</option>
                  <option value="Alta">Alta</option>
                </select>
              </div>
            </div>
            <div class="col-md-2">
              <button id="clearFilters" class="btn btn-outline-secondary w-100">Limpar</button>
            </div>
          </div>
        </div>
      </div>
      <div id="problemsGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
      <nav aria-label="Page navigation" class="mt-4">
        <ul id="pagination" class="pagination justify-content-center"></ul>
      </nav>
    </div>

    <!-- Map Section -->
    <div id="mapSection" class="section d-none">
      <h1 class="display-6 mb-4" data-aos="fade-down">Mapa de Problemas</h1>
      <div class="card mb-4" data-aos="fade-up">
        <div class="card-body">
          <div class="map-container" id="problemsMap"></div>
        </div>
      </div>
    </div>

    <!-- Reports Section -->
    <div id="reportsSection" class="section d-none">
      <h1 class="display-6 mb-4" data-aos="fade-down">Relatórios</h1>
      <div class="card mb-4" data-aos="fade-up">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="select-container">
                <select id="reportPeriod" class="form-select">
                  <option value="30">Último mês</option>
                  <option value="90">Últimos 3 meses</option>
                  <option value="365">Último ano</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6" data-aos="fade-right">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Problemas por Status</h5>
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6" data-aos="fade-left">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Problemas por Urgência</h5>
              <canvas id="urgencyChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Alterar Status do Problema</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label for="editStatus" class="form-label">Status</label>
              <div class="select-container">
                <select class="form-select" id="editStatus">
                  <option value="Aguardando">Aguardando</option>
                  <option value="Em Andamento">Em Andamento</option>
                  <option value="Resolvido">Resolvido</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="saveEdit" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- AOS Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script type="module">
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDVtY6ML3j-qrIsAprIJPB5xFFCbcf4UQw",
      authDomain: "facilita-479b3.firebaseapp.com",
      projectId: "facilita-479b3",
      storageBucket: "facilita-479b3.appspot.com",
      messagingSenderId: "385676676886",
      appId: "1:385676676886:web:6976de7f3abc6c0da94a37"
    };
    
    firebase.initializeApp(firebaseConfig);

    // Firebase Services
    const db = firebase.database();
    const firestore = firebase.firestore();
    const messaging = firebase.messaging();
    const auth = firebase.auth();

    // Configuration
    const ITEMS_PER_PAGE = 6;
    const RETRY_ATTEMPTS = 3;
    const RETRY_DELAY = 1000;

    // State
    let currentPage = 1;
    let allProblems = [];
    let currentLang = 'pt-BR';
    let editModal = null;
    let map = null;

    // Translations
    const translations = {
      'pt-BR': {
        noProblems: 'Nenhum problema encontrado',
        noProblemsAssigned: 'Nenhum problema atribuído a você',
        errorLoading: 'Erro ao carregar problemas',
        errorReports: 'Erro ao carregar relatórios',
        statusUpdated: 'Status atualizado!',
        problemUpdated: 'Problema atualizado com sucesso!',
        errorUpdate: 'Erro ao atualizar: ',
        notificationsActive: 'Notificações ativas',
        notificationsDisabled: 'Notificações desativadas'
      },
      'en-US': {
        noProblems: 'No problems found',
        noProblemsAssigned: 'No problems assigned to you',
        errorLoading: 'Error loading problems',
        errorReports: 'Error loading reports',
        statusUpdated: 'Status updated!',
        problemUpdated: 'Problem updated successfully!',
        errorUpdate: 'Error updating: ',
        notificationsActive: 'Notifications active',
        notificationsDisabled: 'Notifications disabled'
      }
    };

    // Utility Functions
    function translate(key) {
      return translations[document.documentElement.lang || 'pt-BR'][key] || key;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Sem data';
      const date = new Date(timestamp);
      return date.toLocaleString(document.documentElement.lang || 'pt-BR', {
        dateStyle: 'medium',
        timeStyle: 'short'
      });
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      document.body.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      setTimeout(() => toast.remove(), 5000);
    }

    // Initialize AOS
    AOS.init({
      duration: 800,
      easing: 'ease-in-out',
      once: true
    });

    // Navbar Scroll Effect
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      navbar.classList.toggle('scrolled', window.scrollY > 50);
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then((registration) => {
          messaging.useServiceWorker(registration);
          console.log('Service Worker registrado:', registration);
        })
        .catch((error) => {
          console.error('Erro ao registrar Service Worker:', error);
          showToast('Erro ao configurar notificações', 'danger');
        });
    }

    // Notifications
    async function requestNotificationPermission() {
      for (let attempt = 1; attempt <= RETRY_ATTEMPTS; attempt++) {
        try {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            console.log('Permissão de notificações concedida');
            const token = await messaging.getToken({ vapidKey: 'BKnyjZ4OaEOqoOBovd2bu4f-SwrN6WDW6lkSwkd4BQj8RCY5xxQtWFnBSTRWgOksECGYLbVSl-bpJB-pq3yzkkk' });
            document.getElementById('notificationStatus').textContent = translate('notificationsActive');
            console.log('Token de notificação:', token);
            return;
          }
          throw new Error('Permissão de notificações negada');
        } catch (error) {
          console.error(`Tentativa ${attempt} falhou:`, error);
          if (attempt < RETRY_ATTEMPTS) {
            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
          } else {
            document.getElementById('notificationStatus').textContent = translate('notificationsDisabled');
            showToast('Notificações desativadas', 'warning');
          }
        }
      }
    }

    // Initialize Map
    function initializeMap() {
      if (map) map.remove();
      map = L.map('problemsMap').setView([-8.838333, 13.234444], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      allProblems.forEach(problem => {
        if (problem.location && problem.location.latitude && problem.location.longitude) {
          const markerColor = problem.status === 'Resolvido' ? 'green' : problem.status === 'Em Andamento' ? 'orange' : 'red';
          const marker = L.circleMarker([problem.location.latitude, problem.location.longitude], {
            radius: 8,
            fillColor: markerColor,
            color: '#fff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);
          marker.bindPopup(`
            <b>${problem.title || 'Sem título'}</b><br>
            Status: ${problem.status || 'Sem status'}<br>
            Urgência: ${problem.urgency || 'Sem urgência'}<br>
            Município: ${problem.municipality || 'Sem município'}<br>
            Bairro: ${problem.neighborhood || 'Sem bairro'}<br>
            <button class="btn btn-primary btn-sm mt-2" onclick="openEditModal('${problem.id}', '${problem.status || ''}')">Alterar Status</button>
          `);
        }
      });

      if (allProblems.length > 0 && allProblems.some(p => p.location && p.location.latitude && p.location.longitude)) {
        const group = new L.featureGroup(allProblems.map(p => 
          p.location && p.location.latitude && p.location.longitude 
            ? L.marker([p.location.latitude, p.location.longitude]) 
            : null
        ).filter(m => m));
        map.fitBounds(group.getBounds());
      }
    }

    // Admin Panel
    function initializeAdminPanel(userId) {
      const problemsRef = db.ref('relatorios_problemas');
      const problemsGrid = document.getElementById('problemsGrid');
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const urgencyFilter = document.getElementById('urgencyFilter');
      const clearFilters = document.getElementById('clearFilters');
      const sectionLinks = document.querySelectorAll('.nav-link[data-section]');
      const sections = document.querySelectorAll('.section');
      const langLinks = document.querySelectorAll('[data-lang]');
      editModal = new bootstrap.Modal(document.getElementById('editModal'));

      if (!problemsGrid) {
        console.error('Grid de problemas não encontrado!');
        showToast('Erro na inicialização do painel', 'danger');
        return;
      }

      // Load Problems
      problemsRef.on('value', (snapshot) => {
        console.log('Snapshot recebido:', snapshot.exists());
        const problems = snapshot.val();
        allProblems = [];

        if (!problems) {
          console.warn('Nenhum problema encontrado no banco');
          problemsGrid.innerHTML = `<div class="col-12"><p class="text-center text-muted">${translate('noProblems')}</p></div>`;
          renderPagination();
          if (document.getElementById('mapSection').classList.contains('d-none')) {
            initializeMap();
          }
          return;
        }

        allProblems = Object.entries(problems).filter(([_, problem]) => {
          console.log('Verificando problema:', { id: problem.responsibleId, expected: userId });
          return problem.responsibleId === userId;
        }).map(([id, problem]) => ({ id, ...problem }));

        console.log('Problemas filtrados:', allProblems);

        if (allProblems.length === 0) {
          console.warn('Nenhum problema encontrado para responsibleId:', userId);
          problemsGrid.innerHTML = `<div class="col-12"><p class="text-center text-muted">${translate('noProblemsAssigned')}</p></div>`;
        }

        renderProblems();
        if (!document.getElementById('mapSection').classList.contains('d-none')) {
          initializeMap();
        }
      }, (error) => {
        console.error('Erro ao ler problemas:', error);
        problemsGrid.innerHTML = `<div class="col-12"><p class="text-center text-danger">${translate('errorLoading')}</p></div>`;
        showToast('Erro ao carregar dados', 'danger');
      });

      // Render Problems
      function renderProblems() {
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const filteredProblems = filterProblems();
        const paginatedProblems = filteredProblems.slice(start, end);
        problemsGrid.innerHTML = '';

        for (const problem of paginatedProblems) {
          try {
            const createdAt = problem.createdAt ? formatDate(new Date(problem.createdAt.seconds * 1000)) : 'Sem data';
            const urgencyClass = problem.urgency === 'Alta' ? 'text-danger' : problem.urgency === 'Média' ? 'text-warning' : 'text-success';
            const card = document.createElement('div');
            card.className = 'col';
            card.innerHTML = `
              <div class="card h-100 shadow-sm" data-aos="fade-up">
                <div class="card-body">
                  <h5 class="card-title">${problem.title || 'Sem título'}</h5>
                  <p class="card-text"><strong>Descrição:</strong> ${problem.description || 'Sem descrição'}</p>
                  <p class="card-text"><strong>Município:</strong> ${problem.municipality || 'Sem município'}</p>
                  <p class="card-text"><strong>Bairro:</strong> ${problem.neighborhood || 'Sem bairro'}</p>
                  <p class="card-text"><strong>Categoria:</strong> ${problem.category || 'Sem categoria'}</p>
                  <p class="card-text"><strong>Urgência:</strong> <span class="${urgencyClass}">${problem.urgency || 'Sem urgência'}</span></p>
                  <p class="card-text"><strong>Status:</strong> ${problem.status || 'Sem status'}</p>
                  <p class="card-text"><strong>Sugestão:</strong> ${problem.suggestion || 'Sem sugestão'}</p>
                  <p class="card-text"><strong>Criado em:</strong> ${createdAt}</p>
                  ${problem.imageUrl ? `<a href="${problem.imageUrl}" target="_blank"><img src="${problem.imageUrl}" alt="Imagem do problema" class="img-fluid rounded mb-3" style="max-height: 150px;"></a>` : '<p class="text-muted">Sem imagem</p>'}
                </div>
                <div class="card-footer bg-transparent border-0">
                  <div class="d-flex gap-2">
                    <div class="select-container">
                      <select class="form-select" onchange="updateStatus('${problem.id}', this.value)">
                        <option value="Aguardando" ${problem.status === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                        <option value="Em Andamento" ${problem.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                        <option value="Resolvido" ${problem.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                      </select>
                    </div>
                    <button class="btn btn-primary" onclick="openEditModal('${problem.id}', '${problem.status || ''}')">
                      <i class="bi bi-pencil"></i> Alterar Status
                    </button>
                  </div>
                </div>
              </div>
            `;
            problemsGrid.appendChild(card);
          } catch (error) {
            console.error('Erro ao renderizar problema:', problem.id, error);
          }
        }

        renderPagination();
        AOS.refresh();
      }

      // Filter Problems
      function filterProblems() {
        const searchText = searchInput.value.toLowerCase();
        const status = statusFilter.value;
        const urgency = urgencyFilter.value;

        return allProblems.filter(problem => {
          const matchesSearch = problem.title?.toLowerCase().includes(searchText) || problem.description?.toLowerCase().includes(searchText);
          const matchesStatus = !status || problem.status === status;
          const matchesUrgency = !urgency || problem.urgency === urgency;
          return matchesSearch && matchesStatus && matchesUrgency;
        });
      }

      // Pagination
      function renderPagination() {
        const totalPages = Math.ceil(filterProblems().length / ITEMS_PER_PAGE);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        pagination.innerHTML += `
          <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>
          </li>
        `;

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `
            <li class="page-item ${currentPage === i ? 'active' : ''}">
              <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
          `;
        }

        pagination.innerHTML += `
          <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Próximo</a>
          </li>
        `;

        pagination.querySelectorAll('a[data-page]').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
              currentPage = page;
              renderProblems();
            }
          });
        });
      }

      // Event Listeners
      searchInput.addEventListener('input', () => {
        currentPage = 1;
        renderProblems();
      });

      statusFilter.addEventListener('change', () => {
        currentPage = 1;
        renderProblems();
      });

      urgencyFilter.addEventListener('change', () => {
        currentPage = 1;
        renderProblems();
      });

      clearFilters.addEventListener('click', () => {
        searchInput.value = '';
        statusFilter.value = '';
        urgencyFilter.value = '';
        currentPage = 1;
        renderProblems();
      });

      // Section Toggle
      sectionLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.dataset.section;
          sections.forEach(s => s.classList.add('d-none'));
          document.getElementById(`${section}Section`).classList.remove('d-none');
          sectionLinks.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          if (section === 'reports') loadReports(30);
          if (section === 'map') initializeMap();
        });
      });

      // Language Switch
      langLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          currentLang = link.dataset.lang;
          document.documentElement.lang = currentLang;
          updateLanguage();
          renderProblems();
          if (!document.getElementById('reportsSection').classList.contains('d-none')) {
            loadReports(parseInt(document.getElementById('reportPeriod').value));
          }
        });
      });

      // Update Status
      window.updateStatus = async (problemId, newStatus) => {
        try {
          await db.ref(`relatorios_problemas/${problemId}`).update({ status: newStatus });
          console.log('Status atualizado:', problemId, newStatus);
          showToast(translate('statusUpdated'), 'success');
        } catch (error) {
          console.error('Erro ao atualizar status:', problemId, error);
          showToast(`${translate('errorUpdate')} ${error.message}`, 'danger');
        }
      };

      // Edit Modal
      window.openEditModal = (problemId, status) => {
        document.getElementById('editStatus').value = status;
        document.getElementById('saveEdit').dataset.problemId = problemId;
        editModal.show();
      };

      document.getElementById('saveEdit').addEventListener('click', async () => {
        const problemId = document.getElementById('saveEdit').dataset.problemId;
        const newStatus = document.getElementById('editStatus').value;

        try {
          await db.ref(`relatorios_problemas/${problemId}`).update({ status: newStatus });
          console.log('Problema atualizado:', problemId);
          showToast(translate('statusUpdated'), 'success');
          editModal.hide();
        } catch (error) {
          console.error('Erro ao atualizar problema:', error);
          showToast(`${translate('errorUpdate')} ${error.message}`, 'danger');
        }
      });

      // Reports
      async function loadReports(periodDays) {
        try {
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - periodDays);
          const q = firestore.collection('relatorios_problemas').where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startDate));
          const querySnapshot = await q.get();
          const stats = {
            byStatus: { Aguardando: 0, 'Em Andamento': 0, Resolvido: 0 },
            byUrgency: { Baixa: 0, Média: 0, Alta: 0 }
          };

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.responsibleId !== userId) return;
            stats.byStatus[data.status] = (stats.byStatus[data.status] || 0) + 1;
            stats.byUrgency[data.urgency] = (stats.byUrgency[data.urgency] || 0) + 1;
          });

          // Status Chart
          const statusCtx = document.getElementById('statusChart').getContext('2d');
          new Chart(statusCtx, {
            type: 'pie',
            data: {
              labels: Object.keys(stats.byStatus),
              datasets: [{
                data: Object.values(stats.byStatus),
                backgroundColor: ['#ffc107', '#007bff', '#28a745']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'top' } }
            }
          });

          // Urgency Chart
          const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
          new Chart(urgencyCtx, {
            type: 'bar',
            data: {
              labels: Object.keys(stats.byUrgency),
              datasets: [{
                label: 'Problemas',
                data: Object.values(stats.byUrgency),
                backgroundColor: '#dc3545'
              }]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } }
            }
          });
        } catch (error) {
          console.error('Erro ao carregar relatórios:', error);
          showToast(translate('errorReports'), 'danger');
        }
      }

      // Notifications for New Problems
      db.ref('relatorios_problemas').on('child_added', (snapshot) => {
        const problem = snapshot.val();
        if (problem.responsibleId !== userId) return;
        if (Notification.permission === 'granted') {
          new Notification('Novo Problema', {
            body: `${problem.title || 'Sem título'} - ${problem.description || 'Sem descrição'}`,
            icon: '/icons/Icon-192.png'
          });
        }
      }, (error) => {
        console.error('Erro ao configurar notificações:', error);
        showToast('Erro nas notificações', 'danger');
      });

      // Language Update
      function updateLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
          element.textContent = translate(element.dataset.i18n);
        });
      }

      document.getElementById('reportPeriod').addEventListener('change', (e) => {
        loadReports(parseInt(e.target.value));
      });
    }

    // Initialize
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log('Inicializando painel para usuário:', user.uid);
        try {
          const userDoc = await firestore.collection('usuarios').doc(user.uid).get();
          if (userDoc.exists && userDoc.data().isResponsible) {
            initializeAdminPanel(user.uid);
            requestNotificationPermission();
          } else {
            console.warn('Usuário não é responsável:', user.uid);
            await auth.signOut();
            window.location.href = '/login.html';
          }
        } catch (error) {
          console.error('Erro ao verificar usuário:', error);
          await auth.signOut();
          window.location.href = '/login.html';
        }
      } else {
        window.location.href = '/login.html';
      }
    });

    // Logout
    document.getElementById('logoutButton').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        showToast('Erro ao fazer logout', 'danger');
      }
    });
  </script>
</body>
</html>