<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Administrativo - FixABairro</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js"></script>
  <style>
    .sidebar {
      transition: transform 0.3s ease-in-out;
    }
    .sidebar-hidden {
      transform: translateX(-100%);
    }
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        z-index: 1000;
      }
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 bg-gray-800 text-white flex flex-col p-4 md:static md:translate-x-0 sidebar-hidden">
      <div class="flex items-center mb-6">
        <h2 class="text-xl font-bold">FixABairro</h2>
        <button id="sidebarToggle" class="md:hidden ml-auto text-white focus:outline-none">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <nav class="flex-1">
        <ul>
          <li class="mb-2">
            <a href="#" data-section="problems" class="nav-link flex items-center p-2 rounded hover:bg-gray-700 active:bg-gray-600">
              <i class="bi bi-exclamation-circle mr-2"></i> Problemas
            </a>
          </li>
          <li class="mb-2">
            <a href="#" data-section="reports" class="nav-link flex items-center p-2 rounded hover:bg-gray-700">
              <i class="bi bi-bar-chart mr-2"></i> Relatórios
            </a>
          </li>
        </ul>
      </nav>
      <div class="mt-auto">
        <div class="relative mb-2">
          <button id="langDropdown" class="flex items-center p-2 w-full rounded hover:bg-gray-700">
            <i class="bi bi-globe mr-2"></i> Idioma
          </button>
          <ul id="langMenu" class="absolute bottom-full left-0 w-full bg-gray-700 rounded hidden">
            <li><a href="#" data-lang="pt-BR" class="block p-2 hover:bg-gray-600">Português</a></li>
            <li><a href="#" data-lang="en-US" class="block p-2 hover:bg-gray-600">English</a></li>
          </ul>
        </div>
        <button id="logoutButton" class="flex items-center p-2 w-full rounded hover:bg-gray-700">
          <i class="bi bi-box-arrow-right mr-2"></i> Sair
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-auto">
      <header class="bg-white shadow p-4 flex items-center md:hidden">
        <button id="sidebarOpen" class="text-gray-600 focus:outline-none">
          <i class="bi bi-list text-2xl"></i>
        </button>
        <h1 class="ml-4 text-lg font-semibold">Painel Administrativo</h1>
      </header>
      <main class="p-6">
        <!-- Problems Section -->
        <section id="problemsSection" class="section">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Problemas Reportados</h1>
            <span id="notificationStatus" class="px-3 py-1 bg-green-500 text-white rounded-full text-sm"></span>
          </div>
          <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input id="searchInput" type="text" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar por título...">
              <select id="statusFilter" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todos os Status</option>
                <option value="Aguardando">Aguardando</option>
                <option value="Em Andamento">Em Andamento</option>
                <option value="Resolvido">Resolvido</option>
              </select>
              <select id="urgencyFilter" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Todas as Urgências</option>
                <option value="Baixa">Baixa</option>
                <option value="Média">Média</option>
                <option value="Alta">Alta</option>
              </select>
              <button id="clearFilters" class="bg-gray-200 text-gray-700 rounded-lg p-2 hover:bg-gray-300">Limpar</button>
            </div>
          </div>
          <div id="problemsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
          <nav class="mt-6 flex justify-center">
            <ul id="pagination" class="flex space-x-2"></ul>
          </nav>
        </section>

        <!-- Reports Section -->
        <section id="reportsSection" class="section hidden">
          <h1 class="text-2xl font-bold mb-6">Relatórios</h1>
          <div class="bg-white p-4 rounded-lg shadow mb-6">
            <select id="reportPeriod" class="border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="30">Último mês</option>
              <option value="90">Últimos 3 meses</option>
              <option value="365">Último ano</option>
            </select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-lg shadow">
              <h5 class="text-lg font-semibold mb-4">Problemas por Status</h5>
              <canvas id="statusChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
              <h5 class="text-lg font-semibold mb-4">Problemas por Urgência</h5>
              <canvas id="urgencyChart"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <h5 class="text-xl font-semibold">Editar Problema</h5>
        <button id="closeModal" class="text-gray-600 hover:text-gray-800">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <form id="editForm">
        <div class="mb-4">
          <label for="editTitle" class="block text-sm font-medium">Título</label>
          <input type="text" id="editTitle" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label for="editDescription" class="block text-sm font-medium">Descrição</label>
          <textarea id="editDescription" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" required></textarea>
        </div>
        <div class="mb-4">
          <label for="editStatus" class="block text-sm font-medium">Status</label>
          <select id="editStatus" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Aguardando">Aguardando</option>
            <option value="Em Andamento">Em Andamento</option>
            <option value="Resolvido">Resolvido</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="editUrgency" class="block text-sm font-medium">Urgência</label>
          <select id="editUrgency" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Baixa">Baixa</option>
            <option value="Média">Média</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="editSuggestion" class="block text-sm font-medium">Sugestão</label>
          <input type="text" id="editSuggestion" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-4">
          <label for="editImage" class="block text-sm font-medium">Imagem</label>
          <input type="url" id="editImage" class="w-full border rounded-lg p-2 bg-gray-100" readonly>
          <img id="imagePreview" src="" class="mt-2 max-h-48 w-full object-cover rounded hidden">
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
          <button type="button" id="saveEdit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getMessaging, getToken } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js';
    import { auth } from '/auth.js';
    
    // Configuration
    const ITEMS_PER_PAGE = 6;
    const RETRY_ATTEMPTS = 3;
    const RETRY_DELAY = 1000;

    // State
    let currentPage = 1;
    let allProblems = [];
    let currentLang = 'pt-BR';

    // Translations
    const translations = {
      'pt-BR': {
        noProblems: 'Nenhum problema encontrado',
        noProblemsAssigned: 'Nenhum problema atribuído a você',
        errorLoading: 'Erro ao carregar problemas',
        errorReports: 'Erro ao carregar relatórios',
        statusUpdated: 'Status atualizado!',
        problemUpdated: 'Problema atualizado com sucesso!',
        errorUpdate: 'Erro ao atualizar: ',
        notificationsActive: 'Notificações ativas',
        notificationsDisabled: 'Notificações desativadas'
      },
      'en-US': {
        noProblems: 'No problems found',
        noProblemsAssigned: 'No problems assigned to you',
        errorLoading: 'Error loading problems',
        errorReports: 'Error loading reports',
        statusUpdated: 'Status updated!',
        problemUpdated: 'Problem updated successfully!',
        errorUpdate: 'Error updating: ',
        notificationsActive: 'Notifications active',
        notificationsDisabled: 'Notifications disabled'
      }
    };

    // Utility Functions
    function translate(key) {
      return translations[currentLang][key] || key;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Sem data';
      return new Date(timestamp).toLocaleString(currentLang, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 px-4 py-2 text-white rounded-lg bg-${type === 'danger' ? 'red' : type === 'success' ? 'green' : 'yellow'}-500`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(registration => {
          messaging.useServiceWorker(registration);
          console.log('Service Worker registrado');
        })
        .catch(error => {
          console.error('Erro ao registrar Service Worker:', error);
          showToast('Erro ao configurar notificações', 'danger');
        });
    }

    // Notifications
    async function requestNotificationPermission() {
      for (let attempt = 1; attempt <= RETRY_ATTEMPTS; attempt++) {
        try {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            const token = await getToken(messaging, { vapidKey: 'BKnyjZ4OaEOqoOBovd2bu4f-SwrN6WDW6lkSwkd4BQj8RCY5xxQtWFnBSTRWgOksECGYLbVSl-bpJB-pq3yzkkk' });
            document.getElementById('notificationStatus').textContent = translate('notificationsActive');
            return;
          }
          throw new Error('Permissão negada');
        } catch (error) {
          if (attempt === RETRY_ATTEMPTS) {
            document.getElementById('notificationStatus').textContent = translate('notificationsDisabled');
            showToast('Notificações desativadas', 'warning');
          }
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
        }
      }
    }

    // Admin Panel
    function initializeAdminPanel(userId) {
      const db = getDatabase();
      const firestore = getFirestore();
      const messaging = getMessaging();
      const problemsRef = ref(db, 'problems');
      const problemsGrid = document.getElementById('problemsGrid');
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const urgencyFilter = document.getElementById('urgencyFilter');
      const clearFilters = document.getElementById('clearFilters');
      const sectionLinks = document.querySelectorAll('.nav-link[data-section]');
      const sections = document.querySelectorAll('.section');
      const langLinks = document.querySelectorAll('[data-lang]');
      const editModal = document.getElementById('editModal');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarOpen = document.getElementById('sidebarOpen');
      const sidebar = document.getElementById('sidebar');
      const langDropdown = document.getElementById('langDropdown');
      const langMenu = document.getElementById('langMenu');

      // Sidebar Toggle
      sidebarOpen.addEventListener('click', () => sidebar.classList.remove('sidebar-hidden'));
      sidebarToggle.addEventListener('click', () => sidebar.classList.add('sidebar-hidden'));

      // Language Dropdown
      langDropdown.addEventListener('click', () => langMenu.classList.toggle('hidden'));

      // Load Problems
      onValue(problemsRef, snapshot => {
        allProblems = [];
        if (!snapshot.exists()) {
          problemsGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">${translate('noProblems')}</p>`;
          renderPagination();
          return;
        }

        allProblems = Object.entries(snapshot.val())
          .filter(([_, problem]) => problem.responsibleId === userId)
          .map(([id, problem]) => ({ id, ...problem }));

        if (!allProblems.length) {
          problemsGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">${translate('noProblemsAssigned')}</p>`;
        }

        renderProblems();
      }, error => {
        problemsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">${translate('errorLoading')}</p>`;
        showToast('Erro ao carregar dados', 'danger');
      });

      // Render Problems
      function renderProblems() {
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const filteredProblems = filterProblems();
        const paginatedProblems = filteredProblems.slice(start, end);
        problemsGrid.innerHTML = '';

        for (const problem of paginatedProblems) {
          const createdAt = formatDate(problem.createdAt);
          const urgencyClass = problem.urgency === 'Alta' ? 'text-red-500' : problem.urgency === 'Média' ? 'text-yellow-500' : 'text-green-500';
          problemsGrid.innerHTML += `
            <div class="bg-white p-4 rounded-lg shadow card-hover transition-transform">
              <h5 class="text-lg font-semibold">${problem.title || 'Sem título'}</h5>
              <p><strong>Descrição:</strong> ${problem.description || 'Sem descrição'}</p>
              <p><strong>Município:</strong> ${problem.municipality || 'Sem município'}</p>
              <p><strong>Bairro:</strong> ${problem.neighborhood || 'Sem bairro'}</p>
              <p><strong>Categoria:</strong> ${problem.category || 'Sem categoria'}</p>
              <p><strong>Urgência:</strong> <span class="${urgencyClass}">${problem.urgency || 'Sem urgência'}</span></p>
              <p><strong>Status:</strong> ${problem.status || 'Sem status'}</p>
              <p><strong>Sugestão:</strong> ${problem.suggestion || 'Sem sugestão'}</p>
              <p><strong>Criado em:</strong> ${createdAt}</p>
              ${problem.imageUrl ? `<a href="${problem.imageUrl}" target="_blank"><img src="${problem.imageUrl}" alt="Imagem do problema" class="mt-2 rounded max-h-36 w-full object-cover"></a>` : '<p class="text-gray-500">Sem imagem</p>'}
              <div class="mt-4 flex space-x-2">
                <select class="border rounded-lg p-2" onchange="updateStatus('${problem.id}', this.value)">
                  <option value="Aguardando" ${problem.status === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                  <option value="Em Andamento" ${problem.status === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option>
                  <option value="Resolvido" ${problem.status === 'Resolvido' ? 'selected' : ''}>Resolvido</option>
                </select>
                <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600" onclick="openEditModal('${problem.id}', '${problem.title || ''}', '${problem.description || ''}', '${problem.status || ''}', '${problem.urgency || ''}', '${problem.suggestion || ''}', '${problem.imageUrl || ''}')">
                  <i class="bi bi-pencil"></i> Editar
                </button>
              </div>
            </div>
          `;
        }

        renderPagination();
      }

      // Filter Problems
      function filterProblems() {
        const searchText = searchInput.value.toLowerCase();
        const status = statusFilter.value;
        const urgency = urgencyFilter.value;

        return allProblems.filter(problem => {
          const matchesSearch = (problem.title?.toLowerCase().includes(searchText) || problem.description?.toLowerCase().includes(searchText));
          const matchesStatus = !status || problem.status === status;
          const matchesUrgency = !urgency || problem.urgency === urgency;
          return matchesSearch && matchesStatus && matchesUrgency;
        });
      }

      // Pagination
      function renderPagination() {
        const totalPages = Math.ceil(filterProblems().length / ITEMS_PER_PAGE);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        pagination.innerHTML += `
          <li><a href="#" class="px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-300' : 'bg-blue-500 text-white'}" data-page="${currentPage - 1}">Anterior</a></li>
        `;

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `
            <li><a href="#" class="px-3 py-1 rounded ${currentPage === i ? 'bg-blue-500 text-white' : 'bg-gray-200'}" data-page="${i}">${i}</a></li>
          `;
        }

        pagination.innerHTML += `
          <li><a href="#" class="px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-300' : 'bg-blue-500 text-white'}" data-page="${currentPage + 1}">Próximo</a></li>
        `;

        pagination.querySelectorAll('a[data-page]').forEach(link => {
          link.addEventListener('click', e => {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page);
            if (page && page !== currentPage) {
              currentPage = page;
              renderProblems();
            }
          });
        });
      }

      // Event Listeners
      searchInput.addEventListener('input', () => { currentPage = 1; renderProblems(); });
      statusFilter.addEventListener('change', () => { currentPage = 1; renderProblems(); });
      urgencyFilter.addEventListener('change', () => { currentPage = 1; renderProblems(); });
      clearFilters.addEventListener('click', () => {
        searchInput.value = '';
        statusFilter.value = '';
        urgencyFilter.value = '';
        currentPage = 1;
        renderProblems();
      });

      // Section Toggle
      sectionLinks.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const section = link.dataset.section;
          sections.forEach(s => s.classList.add('hidden'));
          document.getElementById(`${section}Section`).classList.remove('hidden');
          sectionLinks.forEach(l => l.classList.remove('active:bg-gray-600'));
          link.classList.add('active:bg-gray-600');
          if (section === 'reports') loadReports(30);
          sidebar.classList.add('sidebar-hidden');
        });
      });

      // Language Switch
      langLinks.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          currentLang = link.dataset.lang;
          langMenu.classList.add('hidden');
          renderProblems();
          if (!document.getElementById('reportsSection').classList.contains('hidden')) {
            loadReports(parseInt(document.getElementById('reportPeriod').value));
          }
        });
      });

      // Update Status
      window.updateStatus = async (problemId, newStatus) => {
        try {
          await update(ref(db, `problems/${problemId}`), { status: newStatus });
          showToast(translate('statusUpdated'), 'success');
        } catch (error) {
          showToast(`${translate('errorUpdate')} ${error.message}`, 'danger');
        }
      };

      // Edit Modal
      window.openEditModal = (problemId, title, description, status, urgency, suggestion, imageUrl) => {
        document.getElementById('editTitle').value = title;
        document.getElementById('editDescription').value = description;
        document.getElementById('editStatus').value = status;
        document.getElementById('editUrgency').value = urgency;
        document.getElementById('editSuggestion').value = suggestion;
        document.getElementById('editImage').value = imageUrl;
        const preview = document.getElementById('imagePreview');
        if (imageUrl) {
          preview.src = imageUrl;
          preview.classList.remove('hidden');
        } else {
          preview.classList.add('hidden');
        }
        document.getElementById('saveEdit').dataset.problemId = problemId;
        editModal.classList.remove('hidden');
      };

      document.getElementById('saveEdit').addEventListener('click', async () => {
        const problemId = document.getElementById('saveEdit').dataset.problemId;
        const updates = {
          title: document.getElementById('editTitle').value.trim(),
          description: document.getElementById('editDescription').value.trim(),
          status: document.getElementById('editStatus').value,
          urgency: document.getElementById('editUrgency').value,
          suggestion: document.getElementById('editSuggestion').value.trim()
        };

        if (!updates.title || !updates.description) {
          showToast('Título e descrição são obrigatórios!', 'warning');
          return;
        }

        try {
          await update(ref(db, `problems/${problemId}`), updates);
          showToast(translate('problemUpdated'), 'success');
          editModal.classList.add('hidden');
        } catch (error) {
          showToast(`${translate('errorUpdate')} ${error.message}`, 'danger');
        }
      });

      document.getElementById('closeModal').addEventListener('click', () => editModal.classList.add('hidden'));
      document.getElementById('cancelEdit').addEventListener('click', () => editModal.classList.add('hidden'));

      // Reports
      async function loadReports(periodDays) {
        try {
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - periodDays);
          const q = query(collection(firestore, 'relatorios_problemas'), where('createdAt', '>=', startDate.getTime()));
          const querySnapshot = await getDocs(q);
          const stats = {
            byStatus: { Aguardando: 0, 'Em Andamento': 0, Resolvido: 0 },
            byUrgency: { Baixa: 0, Média: 0, Alta: 0 }
          };

          querySnapshot.forEach(doc => {
            const data = doc.data();
            if (data.responsibleId !== userId) return;
            stats.byStatus[data.status] = (stats.byStatus[data.status] || 0) + 1;
            stats.byUrgency[data.urgency] = (stats.byUrgency[data.urgency] || 0) + 1;
          });

          new Chart(document.getElementById('statusChart').getContext('2d'), {
            type: 'pie',
            data: {
              labels: Object.keys(stats.byStatus),
              datasets: [{ data: Object.values(stats.byStatus), backgroundColor: ['#ffc107', '#007bff', '#28a745'] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
          });

          new Chart(document.getElementById('urgencyChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: Object.keys(stats.byUrgency),
              datasets: [{ label: 'Problemas', data: Object.values(stats.byUrgency), backgroundColor: '#dc3545' }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          showToast(translate('errorReports'), 'danger');
        }
      }

      // Notifications for New Problems
      onValue(ref(db, 'problems'), snapshot => {
        snapshot.forEach(childSnapshot => {
          const problem = childSnapshot.val();
          if (problem.responsibleId !== userId || Notification.permission !== 'granted') return;
          new Notification('Novo Problema', {
            body: `${problem.title || 'Sem título'} - ${problem.description || 'Sem descrição'}`,
            icon: '/assets/icons/Icon-192.png'
          });
        });
      }, { onlyOnce: false });

      document.getElementById('reportPeriod').addEventListener('change', e => loadReports(parseInt(e.target.value)));
    }

    // Initialize
    auth.onAuthStateChanged(async user => {
      if (user && window.location.pathname === '/index.html') {
        try {
          const userDoc = await getDoc(doc(getFirestore(), 'usuarios', user.uid));
          if (userDoc.exists() && userDoc.data().isResponsible) {
            initializeAdminPanel(user.uid);
            requestNotificationPermission();
          } else {
            await auth.signOut();
            window.location.href = '/login.html';
          }
        } catch (error) {
          await auth.signOut();
          window.location.href = '/login.html';
        }
      }
    });

    // Logout
    document.getElementById('logoutButton').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = '/login.html';
    });
  </script>